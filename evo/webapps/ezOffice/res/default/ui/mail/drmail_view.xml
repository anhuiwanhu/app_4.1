<?xml version="1.0" encoding="utf-8"?>
<imag>
    <script>
        <![CDATA[
			var storage = $phone.localStorage();
			var mailId = storage.getItem('mail_drMailid');
			storage.removeItem("mail_drMailid");
			var evoUrl = storage.getItem('evoUrl');
			$page.onload=function(){
            	$('mailFrom').action=evoUrl+"/ezOffice/mail/mailWrite.do";
            	$("mailid").value=mailId;
            	mailView();
            }
			
			function mailView(){
				$http.post(evoUrl+'/ezOffice/mail/drmailDetail.do', 
					{mailId:mailId}, function(data){
					    var obj = JSON.parse(data);
					    if(obj.logonerror &&obj.logonerror=='1'){
		         		    alert("该账号已在设备"+obj.deviceId+"上登录");
		         		    $page.open('../index.xml',{target:'_self'});
		                    return;
		                }
						var result = obj.message.result;
						var newcontent = obj.newcontent;
						if(result =="1"){
							var data = obj.data;
							if((data.mailtoid+"")==null || (data.mailtoid+"")==""){
								$("mailtoid").value="";
							}else{
								$("mailtoid").value=data.mailtoid;
							}
							if((data.mailtosimple+"")==null || (data.mailtosimple+"")==""){
								$("mailtosimple").value="";
							}else{
								$("mailtosimple").value=data.mailtosimple;
							}
							if((data.mailto+"")==null || (data.mailto+"")==""){
								$("mailto").value="";
							}else{
								$("mailto").value=data.mailto;
							}
							if((data.mailccid+"")==null || (data.mailccid+"")==""){
								$("mailccid").value="";
							}else{
								$("mailccid").value=data.mailccid;
							}
							if((data.mailcc+"")==null || (data.mailcc+"")==""){
								$("mailcc").value="";
							}else{
								$("mailcc").value=data.mailcc;
							}
							if((data.mailccsimple+"")==null || (data.mailccsimple+"")==""){
								$("mailccsimple").value="";
							}else{
								$("mailccsimple").value=data.mailccsimple;
							}
							if((data.mailsubject+"")==null || (data.mailsubject+"")==""
							   || (data.mailsubject+"")=="无主题"){
								$("mailsubject").placeholder="无主题";
							}else{
								$("mailsubject").value=data.mailsubject;
							}
							if(data.maillevel=="2"){
								$("maillevel").checked=true;
							}
							if(data.mailneedrevert=="1"){
								$("mailneedrevert").checked=true;
							}
							if(data.mailSign=="1"){
								$("mailSign").checked=true;
								var gnome = data.gnome+"";
								if(gnome!=null && gnome!=""&&gnome!="null"){
									newcontent += '\r\n\r\n'+gnome;
								}
							}
							if(data.mailanonymous=="1"){
								$("mailanonymous").checked=true;
							}
							$("mailcontent").value=newcontent;
							var objArr = data.attachments;
							$("accessorySize").value=obj.accessorySize;
		                    var accessoryNameseries="";
		                    var accessorySaveNameseries="";
		                    var sfilenames="";
		                	var rfileNames="";
		                    if((objArr+"")!=null && (objArr+"")!=""){
		                    	if(objArr instanceof Array){    //返回多条数据
					        	    for (var i = 0; i < objArr.length; i++) {
					        	        	accessoryNameseries += objArr[i].name+"|";
					        	            rfileNames += objArr[i].name+"$F$";
					        	            accessorySaveNameseries += objArr[i].savename+"|";
					        	            sfilenames += objArr[i].saveName+"$F$";
					        	        }else if(i==objArr.length-1){
					        	            accessoryNameseries += objArr[i].name;
					        	            rfileNames += objArr[i].name;
					        	            accessorySaveNameseries += objArr[i].savename;
					        	            sfilenames += objArr[i].saveName;
					        	        }
					        	    }
					        	    viewFiles(accessoryNameseries,accessorySaveNameseries);
					        	}else if(objArr instanceof Object){   //返回一条数据
					        		rfileNames = objArr.file.name;
					        		sfilenames = objArr.file.savename;
					        	    viewFiles(objArr.file.name,objArr.file.savename);
					        	}
					        	$("rfileNames").value=rfileNames;
			        	    	$("sfilenames").value=sfilenames;
		                    }
						}
					},function(error) {
						toErro(error);
					});
			}
			
			function viewFiles(accessoryNameseries,accessorySaveNameseries){
		    $('docFiles').css('display','block');
		    var path = 'innerMailbox';
            $http.post(evoUrl+'/ezOffice/doc/dealFiles.do',
              {accessoryNameseries:accessoryNameseries,accessorySaveNameseries:accessorySaveNameseries,path:path},
              function(data) {
	               if(data){
	                   var obj = JSON.parse(data);
	                   if(obj.logonerror &&obj.logonerror=='1'){
		         		    alert("该账号已在设备"+obj.deviceId+"上登录");
		         		    $page.open('../index.xml',{target:'_self'});
		                    return;
		               }
		               var attList = obj.attList;
		               if(!attList==""){  //不为空，数据进行迭代,并为附件赋值
		                  for(var k=0;k<attList.length;k++){
		                      var files = $C('<row style="margin-bottom:5"><icon src="mail_fujian.png" style="align:left;width:16;height:16"></icon><label style="color:#38adff;text-decoration:underline;align:left;font-size:16;margin-left:5"  onclick="$http.download(\''+evoUrl+'/ezOffice/download/file.do?url='+attList[k].attachurlser+'&amp;filename='+attList[k].savename+'&amp;uploadPath=innerMailbox'+'&amp;viewName='+attList[k].realname+'\')">'+attList[k].realname+'</label></row>')
		                      $('docFiles').add(files); 
		                  }
		               }else{     //无附件，或者后台处理异常
		               
		               }
	               }
	           },function(error) {
					toErro(error);
				});
        }
			
			function sendMail() {
	            if($('mailto').value.trim().length == 0){
	       			hint('收件人不能为空！');
	       			return false;
	   			}
	   			var subject = $('mailsubject').value.trim();
	   			if(subject.length >200){
	       			hint('主题不能过长！');
	       			return false;
	   			}
	   			if(/[\'\"#$\/&^*?\\]/.test(subject)){
					 alert("主题内容不能输入特殊字符！");
	                 return;
				}
				$('mailFrom').submit(function(data) {
	                var obj = JSON.parse(data);
	                hint(obj.message.description);
	                $page.close();
	            }, function(error) {
	                hint('提交失败！');
	            });
	        }
	
			function selectMailto(){
			    var storage = $phone.localStorage();
		        storage.setItem('sys_selectuser_range','*0*');
		        storage.setItem('sys_selectuser_userids',$('mailtoid').value);
		        storage.setItem('sys_selectuser_usernames',$('mailto').value);
		        storage.setItem('sys_selectuser_returnfuc','completeMailto');
			    $page.open('../public/selectUserOrg.xml', {animation:'down-to-up'});
			}
			function completeMailto(id,name){
			  $('mailtoid').value=id;
			  $('mailto').value=name;
			}
			
			function selectMailcc(){
				var storage = $phone.localStorage();
		        storage.setItem('sys_selectuser_range','*0*');
		        storage.setItem('sys_selectuser_userids',$('mailccid').value);
		        storage.setItem('sys_selectuser_usernames',$('mailcc').value);
		        storage.setItem('sys_selectuser_returnfuc','completeMailcc');
			    $page.open('../public/selectUserOrg.xml', {animation:'down-to-up'});
			}
				
			function completeMailcc(id,name){
				$('mailccid').value=id;
			  	$('mailcc').value=name;
			}
			
			function toErro(error){
				if (error == 'timeout') {
					hint('连接服务器超时！');
				} else if (error == '404') {
					hint('链接超时重新登录！');
				} else if (error == '500') {
					hint('内部服务器错误！');
				} else {
					hint('访问网络错误！错误代码:' + error);
				}
				$page.open('../index.xml',{animation:'down-to-up'});
			}
        ]]>
    </script>

<script>
   <![CDATA[
	var fileindex =0;    //附件最多能上传5个
	var picAddressArr = new Array();
	function fileLoad(){
		var menu = $C('<actionmenu cancelTitle="取消">' +
				 '<item style="text-decoration:underline;color:blue" label="上传图片" onclick="doFilePhotoAlbum(this)"/>' +
				 '<item style="text-decoration:underline;color:blue" label="上传文件" onclick="doFileBrowse(this)"/>' +
			'</actionmenu>');
        menu.show();
	}
	function getAttanchNum(){
		if(fileindex>=5){
			hint('上传附件不能超过5个！');
			return false;
		}
		return true;
	}
	
    function doFilePhotoAlbum(file){    //上传文件选择相册
	    if(!getAttanchNum()){
			return;
		}
		$page.browseImage({
			complete: function(path) {
			  //  alert(path);
			 	var showpath = path.substring(path.lastIndexOf('/')+1,path.length);
			 //	alert(showpath);
	            picAddressArr.push(path);
	            uploadPicView();
	        	fileindex++;
	        },
	        error: function() {
	            hint('上传附件失败！');
	        }
		  });
	}
       
    function uploadPicView(){
        $("picRow").clear();
        for(var i=0;i<picAddressArr.length;i++){
			if(picAddressArr[i]!=null&&picAddressArr[i]!=""&&picAddressArr[i]!=undefined){
		       	var iconRow = $C('<icon src="'+picAddressArr[i]+'" style="width:28;height:28;margin-right:0;" id="icon_'+fileindex+'"/>');
		           $("picRow").add(iconRow);
		           var inputRow = $C('<input type="file" style="display:none;" value="'+picAddressArr[i]+'" name="attachment" />');
		           $("picRow").add(inputRow);
		           var deleteIconRow = $C('<icon relative="icon_'+fileindex+'" position="topright" src="mail_del.png" style="width:8;height:8;margin-right:10" onclick="delPic(\''+i+'\');"/>');
		           $("picRow").add(deleteIconRow);
			}	            
         }
        var uploadPicRow = $C('<icon src="mail_addfu.png" style="width:28;height:28;"  onclick="fileLoad();" />');
   		$("picRow").add(uploadPicRow);
    }
    
    function delPic(index){     //删除图片，index是要删除的图片位置。
		if(confirm('确认删除图片吗？')){
		    picAddressArr.splice(parseInt(index),'1');
		    uploadPicView();
		    fileindex--;
		}
	}
	
	function doFileBrowse(file) {   //附件上传
		if(!getAttanchNum()){
			return;
		}
	    $page.browse({
	        complete: function(path){
	        	var showpath = path.substring(path.lastIndexOf('/')+1,path.length);
	        	if(showpath.indexOf(".") == -1) {
	        		hint("无后缀名的附件不允许上传，请重新选择");
	        		return false;
	        	}
	        	var filenameExt = path.substring(path.lastIndexOf('\.')+1,path.length);
	        	if(filenameExt == 'exe'){
	        	    hint("后缀名为exe的附件不允许上传，请重新选择");
	        		return false;
	        	}
	        	if(filenameExt == 'cmd'){
	        	    hint("后缀名为cmd的附件不允许上传，请重新选择");
	        		return false;
	        	}
	        	if(filenameExt == 'jsp'){
	        	    hint("后缀名为jsp的附件不允许上传，请重新选择");
	        		return false;
	        	}
	        	var row = $C('<row id="row'+fileindex+'"><label id="attachmentId'+fileindex+'" style="color:blue;width:220">'+showpath+'</label><input type="file" style="display:none;" value="'+path+'" name="attachment"  id="input_file'+fileindex+'"/><icon id="imageId" src="mail_del.png" style="width:12;height:12;" onclick="delrow(\''+fileindex+'\');"/></row>');
	        	$("fileCol").add(row);
	        	fileindex++;
	        }
	    });
	    
	}
       
    function delrow(index){   //删除附件
		if(confirm('确认删除附件吗？')){
			$('input_file'+index).value="";
			$("fileCol").remove($('row'+index));
			fileindex--;
		}
	}
  ]]>
</script>
    <page>
        <title style="background:#38adff;tint-color:white">
            <left>
                <button role="back"></button>
            </left>
            <center>
                <label>写邮件</label>
            </center>
            <right>
                <button onclick="sendMail();" style="font-size:18;color:#FFFFFF;">发送</button>
            </right>
        </title>
        <content>
	        <form id="mailFrom" action="/ezOffice/mail/mailWrite.do" progress="提交表单|正在提交表单，请稍后..." multipart="true">
	        	<list>
                    <item style="col-width:100,*" onclick="selectMailto();" accessory="indicator">
                        <col>
                           <label style="font-size:16;color:#555555;">收件人：</label>
                           <input type="hidden" id="mailid" name="mailid"/>
                           <input type="hidden" id="cmd" name="cmd" value="sendMail"/>
                        </col>
                        <col>
                           <input type="hidden" id="mailtoid" name="mailtoid"/>
                           <input type="hidden" id="mailtosimple" name="mailtosimple"/>
                           <input type="text" id="mailto" name="mailto" readonly="true" placeholder="请选择" style="text-align:right;border:0 white;font-size:16;color:#555555;" onclick="selectMailto();"/>
                        </col>
                    </item>
                    <item style="col-width:100,*" onclick="selectMailcc();" accessory="indicator">
                        <col >
                           <label style="font-size:16;color:#555555;">抄送人：</label>
                        </col>
                        <col>
                           <input type="hidden" id="mailccid" name="mailccid"/>
                           <input type="hidden" id="mailccsimple" name="mailccsimple"/>
                           <input type="text" id="mailcc" name="mailcc" readonly="true" placeholder="请选择" style="text-align:right;border:0 white;font-size:16;color:#555555;" onclick="selectMailcc();"/>
                        </col>
                    </item>
                    <item style="col-width:100,*">
                        <col>
                            <label style="font-size:16;color:#555555;">主题：</label>
                        </col>
                        <col>
							<input type="text" id="mailsubject" name="mailsubject" placeholder="请输入" style="text-align:right;border:0 white;font-size:16;color:#555555;"/>
                        </col>
                    </item>
                    <item style="col-width:60,*">
                        <col>
                           <label style="font-size:16;color:#555555;">选项：</label>
                        </col>
                        <col>
                            <row>
                               <checkbox id="maillevel" name="maillevel" value="2" style="align:right;font-size:16;color:#555555;">紧急</checkbox>
                               <checkbox id="mailneedrevert" name="mailneedrevert" value="1" style="align:right;font-size:16;color:#555555;">回执</checkbox>
                               <checkbox id="mailSign" name="mailSign" value="1" style="align:right;font-size:16;color:#555555;">签名</checkbox>
                               <checkbox id="mailanonymous" name="mailanonymous" value="1" style="align:right;font-size:16;color:#555555;">匿名</checkbox>
                            </row>
                        </col>
                    </item>
                    <item style="col-width:100,*">
                        <col>
                           <label style="font-size:16;color:#555555;">附件：</label>
                           <input type="hidden" id="rfileNames" name="rfileNames" value=""/>
	                       <input type="hidden" id="sfilenames" name="sfilenames" value=""/>
	                       <input type="hidden" id="accessorySize" name="accessorySize" value=""/>
                        </col>
                       <col id="fileCol">
							<row id="picRow" style="margin-buttom:10;">
								 <icon src="mail_addfu.png" style="width:28;height:28;" id="uploadPicIcon" onclick="fileLoad();" />
							</row>
						</col>
                    </item>
                    <item id="docFiles" style="display:none;">
                    
                    </item>
                    <item>
                        <label style="margin-bottom:5;font-size:16;color:#555555;">正文：</label>
                        <textarea id="mailcontent" name="mailcontent" rows="7" placeholder="请输入" style="border:0 white;font-size:16;color:#555555;"></textarea>
                    </item>
                </list>
	        </form>
        </content>
    </page>
</imag>